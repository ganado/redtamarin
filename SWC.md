## Introduction ##

A SWC is a library used to shared various components in a zipped form.

It can contains
  * pre-compiled code
  * visual components
  * assets, images, fonts, etc.

With Tamarin you don't really care about SWC<br>
except for one thing: supporting syntax completion in an IDE.<br>
<br>
Most of the editors out there<br>
<ul><li>Flex Builder 3<br>
</li><li>Flash Builder 4<br>
</li><li>FDT<br>
</li><li>Flash Develop<br>
</li><li>etc.</li></ul>

use the content of one or more SWC to allow syntax completion in the IDE.<br>
<br>
See also <a href='http://en.wikipedia.org/wiki/Adobe_SWC_file'>Adobe SWC file on wikipedia</a>.<br>
<br>
<br>
<h2>Details</h2>

Our main problem is that the general SWC out there is generated by COMPC<br>
which reuse <code>airglobal.swc</code> or <code>playerglobal.swc</code> and compile <code>*.as</code> strictly formated code.<br>
<br>
As it is, you can not reuse those defaults to create a SWC based on code for Tamarin<br>
<ul><li>you can not re-use the <code>*.abc</code> files<br>
</li><li>the <code>*.as</code> builtin, shell and native classes are not necessarily strictly formated</li></ul>

but there is a trick we can use :).<br>
<br>
Thanks to <a href='http://www.victordramba.com/'>Victor Dramba</a> for this trick,<br>
it really made me see the light when I thought no solutions could be found ;).<br>
<br>
the trick<br>
<ul><li>you can handcraft a very minimalist <code>builtin.swc</code>
</li><li>based on what you can find in <code>playerglobal.swc</code>
</li><li>very minimalist as you declare only the <b>builtin</b> types (Object, Class, Function, etc.)<br>
</li><li>then you can reuse this <code>builtin.swc</code> to compile with COMPC others <code>*.swc</code> with your native classes</li></ul>

At the condition that you organize your native classes in a strict manner<br>
(eg. only one public per file, one file for each public definition, use typing, etc.)<br>
COMPC will gladly compile the SWC for you.<br>
<br>
But even with that, let's analyze what is a SWC.<br>
<br>
A SWC is a a ZIP file with the extension <code>*.swc</code> which contains 2 files<br>
<ul><li>catalog.xml<br>
</li><li>library.swf</li></ul>

a <code>catalog.xml</code> file look like that<br>
<pre><code>&lt;?xml version="1.0" encoding ="utf-8"?&gt;<br>
&lt;swc xmlns="http://www.adobe.com/flash/swccatalog/9"&gt;<br>
  &lt;versions&gt;<br>
    &lt;swc version="1.2" /&gt;<br>
    &lt;flash version="10.0" build="d566" platform="MAC" /&gt;<br>
  &lt;/versions&gt;<br>
  &lt;features&gt;<br>
    &lt;feature-script-deps /&gt;<br>
    &lt;feature-files /&gt;<br>
  &lt;/features&gt;<br>
  &lt;libraries&gt;<br>
    &lt;library path="library.swf"&gt;<br>
      &lt;script name="ButtonClickSound" mod="1275949831598" &gt;<br>
        &lt;def id="ButtonClickSound" /&gt; <br>
        &lt;dep id="AS3" type="n" /&gt; <br>
        &lt;dep id="flash.media:Sound" type="i" /&gt; <br>
      &lt;/script&gt;<br>
      &lt;script name="EndGameSound" mod="1275949831598" &gt;<br>
        &lt;def id="EndGameSound" /&gt; <br>
        &lt;dep id="AS3" type="n" /&gt; <br>
        &lt;dep id="flash.media:Sound" type="i" /&gt; <br>
      &lt;/script&gt;<br>
    &lt;/library&gt;<br>
  &lt;/libraries&gt;<br>
  &lt;files&gt;<br>
  &lt;/files&gt;<br>
&lt;/swc&gt;<br>
</code></pre>

When you look at the Flex SDK source code<br>
<a href='http://opensource.adobe.com/svn/opensource/flex/sdk/trunk/modules/compiler/src/java/flex2/compiler/swc/catalog/CatalogWriter.java'>/modules/compiler/src/java/flex2/compiler/swc/catalog/CatalogWriter.java</a>

you can learn few other things about <code>catalog.xml</code>

catalog.xml will always have this header<br>
<pre><code>&lt;?xml version="1.0" encoding ="utf-8"?&gt;<br>
&lt;swc xmlns="http://www.adobe.com/flash/swccatalog/9"&gt;<br>
</code></pre>

followed by a version tag<br>
<pre><code>  &lt;versions&gt;<br>
    &lt;swc version="1.0" /&gt;<br>
    &lt;flex version="2.0" build="0" /&gt;<br>
  &lt;/versions&gt;<br>
</code></pre>

there the versions can change depending on which version of the Flex SDK you are using<br>
here another one from <code>playerglobal.swc</code> for FP10 in the Flex SDK 4<br>
<pre><code>  &lt;versions&gt;<br>
    &lt;swc version="1.2" /&gt;<br>
    &lt;flex version="4.0.0" build="0" /&gt;<br>
  &lt;/versions&gt;<br>
</code></pre>

then you have a tag <code>&lt;features&gt;</code>

then a tag <code>&lt;components&gt;</code>

and here where is the real meat, the tag <code>&lt;libraries&gt;</code>

here an example<br>
<pre><code>  &lt;libraries&gt;<br>
    &lt;library path="library.swf"&gt;<br>
      &lt;script name="builtin" mod="1206411565548" &gt;<br>
        &lt;def id="parseInt" /&gt; <br>
        &lt;def id="NaN" /&gt; <br>
        &lt;def id="int" /&gt; <br>
        &lt;def id="Number" /&gt; <br>
        &lt;def id="encodeURI" /&gt; <br>
        &lt;def id="decodeURI" /&gt; <br>
        &lt;def id="Function" /&gt; <br>
        &lt;def id="Array" /&gt; <br>
        &lt;def id="Boolean" /&gt; <br>
        &lt;def id="escape" /&gt; <br>
        &lt;def id="encodeURIComponent" /&gt; <br>
        &lt;def id="isFinite" /&gt; <br>
        &lt;def id="undefined" /&gt; <br>
        &lt;def id="AS3" /&gt; <br>
        &lt;def id="String" /&gt; <br>
        &lt;def id="Class" /&gt; <br>
        &lt;def id="Infinity" /&gt; <br>
        &lt;def id="isNaN" /&gt; <br>
        &lt;def id="Namespace" /&gt; <br>
        &lt;def id="unescape" /&gt; <br>
        &lt;def id="parseFloat" /&gt; <br>
        &lt;def id="uint" /&gt; <br>
        &lt;def id="Object" /&gt; <br>
        &lt;def id="decodeURIComponent" /&gt; <br>
        &lt;dep id="TypeError" type="e" /&gt; <br>
        &lt;dep id="ReferenceError" type="e" /&gt; <br>
        &lt;dep id="RangeError" type="e" /&gt; <br>
        &lt;dep id="Error" type="e" /&gt; <br>
      &lt;/script&gt;<br>
    &lt;/library&gt;<br>
  &lt;/libraries&gt;<br>
</code></pre>

so it works like that, a <code>*.swf</code> can contains any amount of <code>*.abc</code> files,<br>
for each single <code>*.as</code> file taken by the compiler, it will generates a <code>&lt;script&gt;</code> tag.<br>
<br>
The <code>&lt;script&gt;</code> tag have few attributes<br>
<ul><li>name : this is in general the name of the doABC2 tag (or the name of the abc if you prefer)<br>
</li><li>mod : this is the last modified time of the file (we could use <code>FileSystem.getLastModifiedTime( "file.as" )</code> )<br>
</li><li>signatureChecksum : a checksum of the compiled file (didn;t really invested much time in it as it's kind of optional)</li></ul>

So far, so good, <code>name</code> and <code>mod</code> we can create or find those easily.<br>
<br>
Now let's see what we got inside a <code>&lt;script&gt;</code> tag<br>
<ul><li><code>&lt;def id=""&gt;</code>tag, for a definition<br>
</li><li>a <code>&lt;dep id=""&gt;</code> tag for a dependency<br>which can have 4 different types<br>
<ul><li><code>&lt;dep type="i"&gt;</code> for inheritance<br>
</li><li><code>&lt;dep type="n"&gt;</code> for namespace<br>
</li><li><code>&lt;dep type="s"&gt;</code> for signature<br>
</li><li><code>&lt;dep type="e"&gt;</code> for expression</li></ul></li></ul>

Here the most important tag is the definition <code>&lt;def&gt;</code> tag, it tells what is declared/defined<br>
wether it is a constant, variable, function, namespace, class, interface, etc.<br>
<br>
The dependency <code>&lt;dep&gt;</code> tag, well I think we can ignore it<br>
(at the condition that everything is declared in <code>&lt;def&gt;</code> somewhere).<br>
<br>
<br>
<h2>How to build a custom builtin.swc</h2>

All the following is dead WRONG<br>
<pre><code>We not gonna use COMPC for sure, because most of our `*.as` classes will simply not compile&lt;br&gt;<br>
for ex: `Date.as`, we want it in the syntax completion, but as it is, it does not compile.<br>
<br>
In fact, we want to take directly the `builtin.abc` generate by `builtin.py` and inject it in a `library.swf`&lt;br&gt;<br>
using something like `swfmake.as` should do the job.<br>
<br>
Now, our task is to create a `catalog.xml` that will not faill the verification of COMPC and other different IDE.<br>
<br>
Once you have a `library.swf` and `catalog.xml`, really it is just a matter to zip it to `whatever.swc`&lt;br&gt;<br>
and voila you got  a nice valid SWC :).<br>
</code></pre>
<br>
<br>

The following will work in a snap.<br>
<br>

COMPC can generate very low-level SWC, in fact it's so stupid it's even <a href='http://livedocs.adobe.com/flex/3/html/help.html?content=anttasks_4.html'>documented here</a>

look at the part<br>
<pre><code>&lt;include-sources dir="player/avmplus/core" includes="builtin.as, Date.as, Error.as, Math.as, RegExp.as, XML.as"/&gt;<br>
</code></pre>

So here the recipe to generate SWC for our stuff (no dependencies on playerglobal.swc and non-standard classes layout)<br>
<br>
first, you need to override the flex config<br>
<br>
<b>flex-config.xml</b>
<pre><code>&lt;?xml version="1.0"?&gt;<br>
&lt;flex-config&gt;<br>
   &lt;compiler&gt;<br>
      &lt;as3&gt;true&lt;/as3&gt;<br>
      &lt;es&gt;false&lt;/es&gt;<br>
   &lt;/compiler&gt;<br>
&lt;/flex-config&gt;<br>
</code></pre>
just keep the basis, remove anything else.<br>
<br>

second, include only the stuff you need<br>
for ex: <code>builtin.py</code> that generate <code>builtin.abc</code>
<pre><code>os.system(asc+" -builtin "+configs+" -apiversioning -out builtin builtin.as Math.as Error.as Date.as RegExp.as XML.as IDataInput.as IDataOutput.as ByteArray.as ")<br>
</code></pre>

duplicate this for compc<br>
<pre><code>&lt;include-sources dir="src/tamarin/core" includes="builtin.as, Math.as, Error.as, Date.as, RegExp.as, XML.as, IDataInput.as, IDataOutput.as, ByteArray.as" /&gt;<br>
</code></pre>

here an example of the ant task (note I use the Flex SDK 3.2.0, others SDK bigger than v4 seems to not work)<br>
<pre><code>    &lt;target name="build-builtin-component"&gt;<br>
        &lt;compc<br>
            output="bin/builtin.swc"<br>
            target-player="9.0"<br>
        &gt;<br>
            &lt;load-config&gt;flex-config.xml&lt;/load-config&gt;<br>
            &lt;define name="CONFIG::BYTEARRAY_API_FLASH"  value="true" /&gt;<br>
            &lt;define name="CONFIG::BYTEARRAY_API_AIR" value="false" /&gt;<br>
            &lt;strict&gt;false&lt;/strict&gt;<br>
            &lt;optimize&gt;true&lt;/optimize&gt;<br>
            &lt;warnings&gt;false&lt;/warnings&gt;<br>
            &lt;verbose-stacktraces&gt;true&lt;/verbose-stacktraces&gt;<br>
            &lt;compute-digest&gt;false&lt;/compute-digest&gt;<br>
            &lt;include-sources dir="src/tamarin/core" includes="builtin.as, Math.as, Error.as, Date.as, RegExp.as, XML.as, IDataInput.as, IDataOutput.as, ByteArray.as" /&gt;<br>
        &lt;/compc&gt;<br>
    &lt;/target&gt;<br>
</code></pre>
and voila, you obtain a clean <code>builtin.swc</code> without any dependencies on <code>playerglobal.swc</code>.<br>
<br>
<br>

<b>Flex SDK compatibility list</b>
<ul><li>v3.1.0 fail<br>
</li><li>v3.2.0 pass<br>
</li><li>v3.3.0 pass<br>
</li><li>v3.4.0 pass<br>
</li><li>v4.0.0 pass<br>
</li><li>v4.1.0.16076 fail eg "The definition of base class Sprite was not found."<br>
</li><li>v4.5.0.19786 fail eg "The definition of base class Sprite was not found."